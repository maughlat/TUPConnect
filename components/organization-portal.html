<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TUPConnect • Organization Portal</title>
    <link rel="icon" href="../assets/TUPConnect_Logo.png" type="image/png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="../styles/org_navbar.css" />
    <link rel="stylesheet" href="../styles/admin.css" />
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="org-portal-body">
    <div class="background-glow" aria-hidden="true"></div>
    <!-- Organization Navbar -->
    <header class="org-header-custom">
      <div class="org-navbar-content-custom">
        <div class="org-navbar-spacer"></div>
        <a href="#" class="org-navbar-logo-custom" onclick="return false;">
          <img src="../assets/TUPConnect_Logo.png" alt="TUPConnect Logo" class="nav-logo-icon" />
          TUPConnect
        </a>
        <nav class="org-nav-links-custom">
          <a href="#dashboard" class="org-nav-link-custom active" data-section="dashboard">Dashboard</a>
          <a href="#profile" class="org-nav-link-custom" data-section="profile">Profile Management</a>
          <a href="#applications" class="org-nav-link-custom" data-section="applications">Application Review</a>
        </nav>
        <div class="org-navbar-spacer"></div>
        <div class="org-profile-wrapper">
          <button class="org-profile-icon-btn" id="orgProfileBtn" aria-label="Profile menu" title="Profile">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </button>
          <div class="org-profile-dropdown" id="orgProfileDropdown">
            <div class="org-profile-info">
              <div class="org-profile-role" id="orgProfileRole">Org Officer</div>
              <div class="org-profile-email" id="orgProfileEmail">officer@organization.tup.edu.ph</div>
            </div>
            <hr class="org-profile-divider">
            <a href="login.html" class="org-profile-link" id="orgLogoutBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Logout
            </a>
          </div>
        </div>
      </div>
    </header>
    
    <main class="org-main-wrapper">
      <div class="org-content-centered">
          <!-- Dashboard Section -->
          <section id="dashboard" class="org-section active">
            <div class="admin-content-header">
              <h1>Dashboard Overview</h1>
            </div>

            <div class="dashboard-cards">
              <div class="dashboard-card">
                <div class="dashboard-card-icon pending">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </div>
                <div class="dashboard-card-content">
                  <h3>Pending Requests</h3>
                  <p class="dashboard-card-value" id="pendingCount">0</p>
                  <p class="dashboard-card-label">Applications awaiting review</p>
                </div>
              </div>

              <div class="dashboard-card">
                <div class="dashboard-card-icon members">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                </div>
                <div class="dashboard-card-content">
                  <h3>Total Members</h3>
                  <p class="dashboard-card-value" id="totalMembers">0</p>
                  <p class="dashboard-card-label">Active organization members</p>
                </div>
              </div>

              <div class="dashboard-card">
                <div class="dashboard-card-icon profile">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <div class="dashboard-card-content">
                  <h3>Profile Completion</h3>
                  <p class="dashboard-card-value" id="profileCompletion">0%</p>
                  <p class="dashboard-card-label" id="profileStatus">Incomplete</p>
                </div>
              </div>
            </div>
          </section>

          <!-- Profile Management Section -->
          <section id="profile" class="org-section">
            <div class="admin-content-header">
              <h1>Profile Management</h1>
            </div>
            <p style="color: var(--muted); font-size: 0.95rem; margin-bottom: 1.5rem;">Update your organization's public-facing information</p>

            <div class="org-table-container">
              <form id="profileForm" class="profile-form">
                <div class="form-group">
                  <label for="orgAbout">About Section *</label>
                  <textarea
                    id="orgAbout"
                    name="orgAbout"
                    rows="6"
                    placeholder="Describe your organization's mission, values, and purpose..."
                    required
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="orgActivities">Activities & Focus *</label>
                  <textarea
                    id="orgActivities"
                    name="orgActivities"
                    rows="5"
                    placeholder="List your organization's key activities, events, and focus areas. You can use bullet points or paragraphs..."
                    required
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="facebookLink">Facebook Page Link</label>
                  <input
                    type="url"
                    id="facebookLink"
                    name="facebookLink"
                    placeholder="https://facebook.com/your-organization"
                  />
                  <small style="color: var(--muted); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Your organization's official Facebook page URL
                  </small>
                </div>

                <div class="form-group">
                  <label for="orgProfilePicture">Profile Picture</label>
                  <input
                    type="file"
                    id="orgProfilePicture"
                    name="orgProfilePicture"
                    accept="image/png,image/jpeg,image/jpg,image/webp"
                  />
                  <small style="color: var(--muted); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Upload your organization logo/profile picture (PNG, JPG, or WebP). Maximum file size: 2MB
                  </small>
                  <div id="profilePicturePreview" style="margin-top: 1rem; display: none;">
                    <img id="previewImage" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);" />
                  </div>
                </div>

                <div class="form-actions" style="margin-top: 2rem;">
                  <button type="button" class="btn-secondary" id="resetProfileBtn">Reset</button>
                  <button type="submit" class="btn-primary">Save Changes</button>
                </div>

                <div class="modal-message" id="profileMessage" style="margin-top: 1rem;"></div>
              </form>
            </div>
          </section>

          <!-- Application Review Section -->
          <section id="applications" class="org-section">
            <div class="admin-content-header">
              <h1>Application Review</h1>
            </div>
            <p style="color: var(--muted); font-size: 0.95rem; margin-bottom: 1.5rem;">Review and process student applications to join your organization</p>

            <div class="org-table-container">
              <table class="org-table">
                <thead>
                  <tr>
                    <th>Student Name</th>
                    <th>Student Email</th>
                    <th>Submitted CV/Resume</th>
                    <th>Date Submitted</th>
                    <th>Status</th>
                    <th>View</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="applicationsTableBody">
                  <!-- Applications will be dynamically inserted here -->
                </tbody>
              </table>
            </div>
          </section>
        </div>
      </div>
    </main>

    <!-- Application View Modal -->
    <div id="applicationViewModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop" id="applicationViewModalBackdrop"></div>
      <div class="modal-container">
        <button class="modal-close" id="applicationViewModalClose" aria-label="Close modal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <div class="modal-header">
          <h2>Application Details</h2>
        </div>
        <div class="modal-body" id="applicationViewContent">
          <!-- Application details will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="applicationViewCloseBtn">Close</button>
        </div>
      </div>
    </div>

    <script type="module">
      // Initialize Supabase client (same pattern as admin-dashboard.html)
      const supabaseUrl = 'https://rbmfimbdtiyuiflunuhx.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJibWZpbWJkdGl5dWlmbHVudWh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA4MDQsImV4cCI6MjA4MDYwNjgwNH0.5LUfiV2PH78x5ExLROR9b0Z9j1O1ND75JJdGnEg2r4E';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

      // Verify session and role on page load - only allow 'org_officer' role
      let sessionData = null;
      document.addEventListener('DOMContentLoaded', async () => {
        // Verify session (inline logic, same pattern as admin-dashboard.html)
        try {
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();

          if (sessionError || !session || !session.user) {
            window.location.href = 'login.html?error=session_expired';
            return;
          }

          const userId = session.user.id;

          // Get user's role from user_roles table
          const { data: userRoleData, error: roleError } = await supabase
            .from('user_roles')
            .select('role, organization_id')
            .eq('user_id', userId)
            .single();

          if (roleError || !userRoleData) {
            await supabase.auth.signOut();
            window.location.href = 'login.html?error=no_role_assigned';
            return;
          }

          const userRole = userRoleData.role;

          // Check if user's role is org_officer
          if (userRole !== 'org_officer') {
            await supabase.auth.signOut();
            window.location.href = 'login.html?error=access_denied';
            return;
          }

          sessionData = {
            isAuthenticated: true,
            user: session.user,
            role: userRole,
            organizationId: userRoleData.organization_id
          };

          // Store role and organization ID in localStorage
          localStorage.setItem('tupconnect_user_role', userRole);
          if (userRoleData.organization_id) {
            localStorage.setItem('tupconnect_organization_id', userRoleData.organization_id);
          }
        } catch (error) {
          console.error('Session verification error:', error);
          window.location.href = 'login.html?error=verification_failed';
          return;
        }

        if (!sessionData || !sessionData.isAuthenticated) {
          return;
        }

        // User is authenticated as org_officer
        console.log('Org Officer authenticated:', sessionData.user.email);
        console.log('Organization ID:', sessionData.organizationId);

        // Update profile info in navbar
        const orgProfileEmailEl = document.getElementById('orgProfileEmail');
        const orgProfileRoleEl = document.getElementById('orgProfileRole');
        if (orgProfileEmailEl && sessionData.user.email) {
          orgProfileEmailEl.textContent = sessionData.user.email;
        }
        if (orgProfileRoleEl) {
          orgProfileRoleEl.textContent = 'Org Officer';
        }

        // Initialize organization navbar functionality
        const orgProfileBtn = document.getElementById('orgProfileBtn');
        const orgProfileDropdown = document.getElementById('orgProfileDropdown');
        const orgProfileWrapper = document.querySelector('.org-profile-wrapper');
        const orgLogoutBtn = document.getElementById('orgLogoutBtn');

        if (orgProfileBtn && orgProfileDropdown) {
          // Toggle on click
          orgProfileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            orgProfileDropdown.classList.toggle('show');
          });

          // Close when clicking outside
          document.addEventListener('click', function(e) {
            if (orgProfileWrapper && !orgProfileWrapper.contains(e.target)) {
              orgProfileDropdown.classList.remove('show');
            }
          });

          // Prevent dropdown from closing when clicking inside it
          orgProfileDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }

        // Handle logout
        if (orgLogoutBtn) {
          orgLogoutBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            try {
              await supabase.auth.signOut();
              sessionStorage.clear();
              localStorage.removeItem('tupconnect_user_role');
              localStorage.removeItem('tupconnect_organization_id');
              window.location.href = 'login.html';
            } catch (error) {
              console.error('Logout error:', error);
              window.location.href = 'login.html';
            }
          });
        }

        // Initialize portal with organization ID
        if (sessionData.organizationId) {
          await initOrganizationPortal(sessionData.organizationId);
        } else {
          console.error('No organization ID found');
          window.location.href = 'login.html?error=no_organization';
        }
      });

      /**
       * Fetch organization data for the logged-in officer
       * Retrieves the organization record using the ID stored in localStorage
       * 
       * @returns {Promise<Object>} Returns { success: boolean, data: Object|null, error: string|null }
       *                            - success: true if organization was found and retrieved
       *                            - data: The organization object with all fields, or null if error
       *                            - error: Error message string, or null if successful
       */
      async function fetchOrgDataForOfficer() {
        try {
          // Step 1: Get organization ID from localStorage
          const orgId = localStorage.getItem('tupconnect_organization_id');

          if (!orgId) {
            console.error('❌ Organization ID not found in localStorage');
            return {
              success: false,
              data: null,
              error: 'Organization ID not found. Please log in again.'
            };
          }

          console.log('Fetching organization data for ID:', orgId);

          // Step 2: Query Supabase for the organization
          const { data: organization, error: queryError } = await supabase
            .from('organizations')
            .select('*')
            .eq('id', orgId)
            .single();

          // Step 3: Handle query errors
          if (queryError) {
            console.error('❌ Error fetching organization:', queryError);
            
            // Handle specific error cases
            if (queryError.code === 'PGRST116') {
              // No rows returned - organization not found
              return {
                success: false,
                data: null,
                error: 'Organization not found. Please contact an administrator.'
              };
            }

            return {
              success: false,
              data: null,
              error: queryError.message || 'Failed to fetch organization data. Please try again.'
            };
          }

          // Step 4: Verify data exists
          if (!organization) {
            console.error('❌ Organization data is null');
            return {
              success: false,
              data: null,
              error: 'Organization data not found.'
            };
          }

          console.log('✓ Organization data fetched successfully:', organization.name);
          return {
            success: true,
            data: organization,
            error: null
          };

        } catch (error) {
          // Handle unexpected errors
          console.error('❌ Unexpected error in fetchOrgDataForOfficer:', error);
          return {
            success: false,
            data: null,
            error: error.message || 'An unexpected error occurred while fetching organization data.'
          };
        }
      }

      // Global variables for organization and application data
      let currentOrganization = null;
      let organizationProfile = null;
      let applications = [];

      /**
       * Main initialization function for the Organization Portal
       * Called after successful authentication and role verification
       * 
       * @param {string} organizationId - The UUID of the organization
       */
      async function initOrganizationPortal(organizationId) {
        console.log('Initializing organization portal for ID:', organizationId);

        // Fetch organization data
        const orgResult = await fetchOrgDataForOfficer();
        if (!orgResult.success || !orgResult.data) {
          console.error('Failed to fetch organization data:', orgResult.error);
          alert('Failed to load organization data. Please refresh the page or contact support.');
          return;
        }

        currentOrganization = orgResult.data;
        console.log('Organization loaded:', currentOrganization.name);

        // Fetch organization profile (extended info)
        await fetchOrganizationProfile(organizationId);

        // Fetch applications
        await fetchApplications(organizationId);

        // Initialize navigation
        initializeNavigation();

        // Initialize dashboard with real data
        updateDashboard();

        // Load profile form with real data
        loadProfile();

        // Render applications table with real data
        renderApplications();

        // Initialize profile form handlers
        initializeProfileForm(organizationId);

        // Initialize application view modal
        initializeApplicationViewModal();

        console.log('Organization portal initialized successfully');
      }

      // Navigation handling
      const navItems = document.querySelectorAll('.org-nav-link-custom[data-section]');
      const sections = document.querySelectorAll('.org-section');

      navItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const targetSection = this.getAttribute('data-section');

          // Update active nav item
          navItems.forEach(nav => nav.classList.remove('active'));
          this.classList.add('active');

          // Show target section
          sections.forEach(section => {
            section.classList.remove('active');
            if (section.id === targetSection) {
              section.classList.add('active');
            }
          });
        });
      });

      /**
       * Fetch organization profile (extended info from org_profiles table)
       */
      async function fetchOrganizationProfile(organizationId) {
        try {
          const { data: profile, error } = await supabase
            .from('org_profiles')
            .select('*')
            .eq('organization_id', organizationId)
            .maybeSingle();

          if (error && error.code !== 'PGRST116') {
            console.error('Error fetching organization profile:', error);
          }

          organizationProfile = profile || {
            mission: currentOrganization?.description || '',
            objectives: [],
            membership_info: ''
          };

          // Convert objectives array to text if needed
          if (Array.isArray(organizationProfile.objectives)) {
            organizationProfile.activities = organizationProfile.objectives.join('\n• ');
          }

          console.log('Organization profile loaded');
        } catch (error) {
          console.error('Error in fetchOrganizationProfile:', error);
          organizationProfile = {
            mission: currentOrganization?.description || '',
            objectives: [],
            membership_info: ''
          };
        }
      }

      /**
       * Fetch applications for this organization
       * Alias for fetchOrgApplications
       */
      async function fetchApplications(organizationId) {
        return await fetchOrgApplications(organizationId);
      }

      /**
       * Fetch applications for the logged-in organization
       * @param {string} orgId - Organization ID
       * @returns {Promise<Array>} Array of application records
       */
      async function fetchOrgApplications(orgId) {
        try {
          const { data: apps, error } = await supabase
            .from('applications')
            .select('*')
            .eq('organization_id', orgId)
            .order('date_submitted', { ascending: false });

          if (error) {
            console.error('Error fetching applications:', error);
            applications = [];
            return [];
          }

          applications = apps || [];
          console.log(`Loaded ${applications.length} applications`);
          return applications;
        } catch (error) {
          console.error('Error in fetchOrgApplications:', error);
          applications = [];
          return [];
        }
      }

      /**
       * Initialize navigation between sections
       */
      function initializeNavigation() {
        const navItems = document.querySelectorAll('.org-nav-link-custom[data-section]');
        const sections = document.querySelectorAll('.org-section');

        navItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetSection = this.getAttribute('data-section');

            // Update active nav item
            navItems.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');

            // Show target section
            sections.forEach(section => {
              section.classList.remove('active');
              if (section.id === targetSection) {
                section.classList.add('active');
              }
            });
          });
        });
      }

      // Dashboard functions
      function updateDashboard() {
        const pendingCount = applications.filter(app => app.status === 'Pending').length;
        const totalMembers = applications.filter(app => app.status === 'Approved').length;
        
        // Calculate profile completion based on organization data
        let completionScore = 0;
        const hasDescription = currentOrganization?.description && currentOrganization.description.trim().length > 50;
        const hasActivities = currentOrganization?.activities && (
          (Array.isArray(currentOrganization.activities) && currentOrganization.activities.length > 0) ||
          (typeof currentOrganization.activities === 'string' && currentOrganization.activities.trim().length > 50)
        );
        const hasFacebookLink = currentOrganization?.facebook_link && currentOrganization.facebook_link.trim().length > 0;

        if (hasDescription) completionScore += 34;
        if (hasActivities) completionScore += 33;
        if (hasFacebookLink) completionScore += 33;

        document.getElementById('pendingCount').textContent = pendingCount;
        document.getElementById('totalMembers').textContent = totalMembers;
        document.getElementById('profileCompletion').textContent = `${completionScore}%`;
        
        const profileStatusEl = document.getElementById('profileStatus');
        if (completionScore === 100) {
          profileStatusEl.textContent = 'Complete';
          profileStatusEl.style.color = '#16a34a';
        } else if (completionScore >= 66) {
          profileStatusEl.textContent = 'Almost Complete';
          profileStatusEl.style.color = '#d97706';
        } else {
          profileStatusEl.textContent = 'Incomplete';
          profileStatusEl.style.color = '#dc2626';
        }
      }

      // Profile Management functions
      function loadProfile() {
        // Load data from current organization
        const aboutText = currentOrganization?.description || '';
        const activitiesText = currentOrganization?.activities 
          ? (Array.isArray(currentOrganization.activities) 
              ? currentOrganization.activities.map(a => '• ' + a).join('\n')
              : currentOrganization.activities)
          : '';
        const facebookLink = currentOrganization?.facebook_link || '';
        const logoUrl = currentOrganization?.logo || '';

        document.getElementById('orgAbout').value = aboutText;
        document.getElementById('orgActivities').value = activitiesText;
        document.getElementById('facebookLink').value = facebookLink;
        
        // Load profile picture preview if logo exists
        if (logoUrl) {
          const preview = document.getElementById('profilePicturePreview');
          const previewImg = document.getElementById('previewImage');
          if (preview && previewImg) {
            previewImg.src = logoUrl;
            preview.style.display = 'block';
          }
        }
      }

      /**
       * Upload Organization Profile Picture to Supabase Storage
       * @param {File} file - The image file to upload
       * @param {string} orgId - Organization ID
       * @returns {Promise<string>} Public URL of the uploaded image
       */
      async function uploadOrgProfilePicture(file, orgId) {
        try {
          // Validate file size (2MB limit)
          const maxSize = 2 * 1024 * 1024; // 2MB in bytes
          if (file.size > maxSize) {
            throw new Error('File size exceeds 2MB limit. Please upload a smaller image.');
          }

          // Validate file type
          const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
          if (!allowedTypes.includes(file.type)) {
            throw new Error('Invalid file type. Please upload PNG, JPG, or WebP image.');
          }

          // Generate unique filename: orgId_timestamp.ext
          const timestamp = Date.now();
          const fileExt = file.name.split('.').pop().toLowerCase();
          const fileName = `${orgId}_${timestamp}.${fileExt}`;
          const filePath = `${orgId}/${fileName}`;

          // Upload file to Supabase Storage (logos bucket)
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('logos')
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: true // Allow overwriting if same org uploads again
            });

          if (uploadError) {
            throw new Error(`Upload failed: ${uploadError.message}`);
          }

          // Get public URL
          const { data: { publicUrl } } = supabase.storage
            .from('logos')
            .getPublicUrl(filePath);

          console.log('Profile picture uploaded successfully:', publicUrl);
          return publicUrl;
        } catch (error) {
          console.error('Error uploading profile picture:', error);
          throw error;
        }
      }

      /**
       * Handle Organization Profile Update
       * Single Source of Truth (SSOT): All profile data saved to public.organizations table
       * @param {string} orgId - Organization ID
       * @param {FormData} formData - Form data containing profile fields
       */
      async function handleUpdateOrgProfile(orgId, formData) {
        try {
          const messageEl = document.getElementById('profileMessage');
          
          // Get form values - All fields from the profile management form
          const aboutValue = document.getElementById('orgAbout').value.trim();
          const activitiesValue = document.getElementById('orgActivities').value.trim();
          const facebookLinkValue = document.getElementById('facebookLink').value.trim();
          const profilePictureFile = document.getElementById('orgProfilePicture').files[0];

          // Convert activities text to array (handles bullet points, dashes, etc.)
          const activitiesArray = activitiesValue
            .split('\n')
            .map(line => line.replace(/^[•\-\*]\s*/, '').trim())
            .filter(line => line.length > 0);

          // Prepare update data object for public.organizations table (SSOT)
          // This consolidates ALL profile fields into a single database update
          let updateData = {
            // Description/About section - stores the main "About" content
            description: aboutValue || null,
            
            // Activities array - stores list of activities/focus areas
            activities: activitiesArray.length > 0 ? activitiesArray : null,
            
            // Facebook link - stores official Facebook page URL
            facebook_link: facebookLinkValue || null
          };

          // Upload profile picture if provided and save URL to logo column
          if (profilePictureFile) {
            showMessage('Uploading profile picture...', 'success', messageEl);
            const logoUrl = await uploadOrgProfilePicture(profilePictureFile, orgId);
            // Save the Supabase Storage public URL to the logo column (SSOT)
            updateData.logo = logoUrl;
          }

          // Single database update to public.organizations table (SSOT principle)
          // This ensures all profile data is stored in one centralized location
          showMessage('Saving profile changes...', 'success', messageEl);
          const { data: updatedOrg, error: updateError } = await supabase
            .from('organizations')
            .update(updateData)
            .eq('id', orgId)
            .select()
            .single();

          if (updateError) {
            throw new Error(`Failed to update organization profile: ${updateError.message}`);
          }

          // Update local cached data to reflect changes immediately
          if (currentOrganization) {
            currentOrganization.description = aboutValue;
            currentOrganization.activities = activitiesArray;
            currentOrganization.facebook_link = facebookLinkValue;
            if (updateData.logo) {
              currentOrganization.logo = updateData.logo;
            }
          }

          // Update preview image if logo was changed
          if (updateData.logo) {
            const previewImg = document.getElementById('previewImage');
            if (previewImg) {
              previewImg.src = updateData.logo;
            }
          }

          // Show success message
          showMessage('✓ Profile Updated Successfully! Your organization profile has been saved and will be visible to students.', 'success', messageEl);

          // Refresh dashboard to reflect updated profile completion
          updateDashboard();

          // Hide message after 5 seconds
          setTimeout(() => {
            if (messageEl) {
              messageEl.style.display = 'none';
            }
          }, 5000);

          console.log('Profile updated successfully (SSOT):', updatedOrg);
        } catch (error) {
          console.error('Error updating profile:', error);
          const messageEl = document.getElementById('profileMessage');
          showMessage(`✗ Error: ${error.message || 'Failed to update profile. Please try again.'}`, 'error', messageEl);
        }
      }

      /**
       * Helper function to show messages
       */
      function showMessage(message, type, messageEl) {
        if (!messageEl) return;
        const bgColor = type === 'success' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
        const borderColor = type === 'success' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)';
        const textColor = type === 'success' ? '#16a34a' : '#dc2626';
        
        messageEl.innerHTML = `
          <div style="padding: 1rem; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 12px; color: ${textColor};">
            <strong>${message}</strong>
          </div>
        `;
        messageEl.style.display = 'block';
      }

      /**
       * Initialize profile form with event handlers
       */
      function initializeProfileForm(organizationId) {
        const profileForm = document.getElementById('profileForm');
        const resetBtn = document.getElementById('resetProfileBtn');

        if (!profileForm) return;

        // Handle profile picture upload preview
        const profilePictureInput = document.getElementById('orgProfilePicture');
        const previewContainer = document.getElementById('profilePicturePreview');
        const previewImage = document.getElementById('previewImage');
        
        if (profilePictureInput && previewImage) {
          profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                previewImage.src = e.target.result;
                if (previewContainer) {
                  previewContainer.style.display = 'block';
                }
              };
              reader.readAsDataURL(file);
            } else {
              if (previewContainer) {
                previewContainer.style.display = 'none';
              }
            }
          });
        }

        // Save original values for reset
        let originalValues = {
          about: document.getElementById('orgAbout').value,
          activities: document.getElementById('orgActivities').value,
          facebookLink: document.getElementById('facebookLink').value
        };

        profileForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await handleUpdateOrgProfile(organizationId, new FormData(profileForm));
        });

        if (resetBtn) {
          resetBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all changes? This will restore the last saved values.')) {
              document.getElementById('orgAbout').value = originalValues.about;
              document.getElementById('orgActivities').value = originalValues.activities;
              document.getElementById('facebookLink').value = originalValues.facebookLink;
              if (profilePictureInput) {
                profilePictureInput.value = '';
              }
              if (previewContainer) {
                previewContainer.style.display = 'none';
              }
            }
          });
        }
      }

      // Application Review functions
      function renderApplications() {
        const tbody = document.getElementById('applicationsTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (applications.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem; color: var(--muted);">
                No applications found. Applications from students will appear here.
              </td>
            </tr>
          `;
          updateDashboard();
          return;
        }

        applications.forEach(app => {
          const row = document.createElement('tr');
          const statusBadge = app.status === 'Pending' 
            ? '<span class="status-badge pending">Pending</span>'
            : app.status === 'Approved'
            ? '<span class="status-badge active">Approved</span>'
            : '<span class="status-badge inactive">Rejected</span>';

          const dateStr = app.date_submitted 
            ? new Date(app.date_submitted).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
            : 'N/A';

          row.innerHTML = `
            <td>${escapeHtml(app.student_name || 'N/A')}</td>
            <td>${escapeHtml(app.personal_email || 'N/A')}</td>
            <td>
              ${app.cv_link ? `
                <a href="${escapeHtml(app.cv_link)}" class="cv-download-link" target="_blank" rel="noopener noreferrer" onclick="handleCvDownload(event, '${app.id}')">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  View CV
                </a>
              ` : '<span style="color: var(--muted);">No CV</span>'}
            </td>
            <td>${escapeHtml(dateStr)}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn-action-icon" onclick="viewApplication('${app.id}')" title="View Application Details">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
            </td>
            <td>
              <div class="org-actions">
                ${app.status === 'Pending' ? `
                  <button class="btn-action-icon btn-accept-icon" onclick="handleApplication('${app.id}', 'Approved')" title="Accept Application">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </button>
                  <button class="btn-action-icon btn-reject-icon" onclick="handleApplication('${app.id}', 'Rejected')" title="Reject Application">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                ` : `
                  <span style="color: var(--muted); font-size: 0.85rem;">${escapeHtml(app.status)}</span>
                `}
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });

        // Update dashboard after rendering
        updateDashboard();
      }

      /**
       * Update application status (Approve/Reject)
       * Alias for updateApplicationStatus
       */
      async function handleApplication(appId, newStatus) {
        return await updateApplicationStatus(appId, newStatus);
      }

      /**
       * Update application status (Approve/Reject)
       * @param {string} applicationId - Application ID
       * @param {string} newStatus - New status ('Approved' or 'Rejected')
       */
      async function updateApplicationStatus(applicationId, newStatus) {
        const app = applications.find(a => a.id === applicationId);
        if (!app) {
          console.error('Application not found:', applicationId);
          alert('Application not found. Please refresh the page.');
          return;
        }

        try {
          // Get current user ID for reviewed_by field
          const { data: { session } } = await supabase.auth.getSession();
          const reviewedBy = session?.user?.id || null;

          // Update application status in database
          const { error } = await supabase
            .from('applications')
            .update({
              status: newStatus,
              reviewed_at: new Date().toISOString(),
              reviewed_by: reviewedBy
            })
            .eq('id', applicationId);

          if (error) {
            throw new Error('Failed to update application: ' + error.message);
          }

          // Update local data
          app.status = newStatus;
          app.reviewed_at = new Date().toISOString();
          app.reviewed_by = reviewedBy;

          // Re-render applications table
          renderApplications();

          // Show notification with email confirmation message if approved
          const notification = document.createElement('div');
          notification.style.cssText = 'position: fixed; top: 100px; right: 20px; background: rgba(34, 197, 94, 0.95); color: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 10000; font-family: "Space Grotesk", sans-serif; max-width: 350px;';
          
          if (newStatus === 'Approved') {
            notification.innerHTML = `
              <strong>✓ Application Approved</strong><br>
              ${app.student_name}'s application has been approved and they have been successfully added as a member of this organization.
            `;
          } else {
            notification.innerHTML = `<strong>✓ Application Rejected</strong><br>${app.student_name}'s application has been rejected.`;
          }

          document.body.appendChild(notification);

          setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            setTimeout(() => notification.remove(), 5000);
          }, 3000);

          console.log(`Application ${applicationId} ${newStatus.toLowerCase()}`);
        } catch (error) {
          console.error('Error updating application:', error);
          alert('Failed to update application. Please try again.');
        }
      }

      // Make function globally available for onclick handlers
      window.handleApplication = handleApplication;
      window.updateApplicationStatus = updateApplicationStatus;

      /**
       * Escape HTML to prevent XSS attacks
       */
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      /**
       * View application details in modal
       * @param {string} applicationId - Application ID
       */
      function viewApplication(applicationId) {
        const app = applications.find(a => a.id === applicationId);
        if (!app) {
          alert('Application not found. Please refresh the page.');
          return;
        }

        const modal = document.getElementById('applicationViewModal');
        const content = document.getElementById('applicationViewContent');

        // Format date
        const submittedDate = app.date_submitted 
          ? new Date(app.date_submitted).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })
          : 'N/A';

        const reviewedDate = app.reviewed_at
          ? new Date(app.reviewed_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })
          : 'Not reviewed yet';

        const statusBadge = app.status === 'Pending' 
          ? '<span class="status-badge pending">Pending</span>'
          : app.status === 'Approved'
          ? '<span class="status-badge active">Approved</span>'
          : '<span class="status-badge inactive">Rejected</span>';

        // Render application details as read-only form
        content.innerHTML = `
          <div style="display: grid; gap: 1.5rem;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">Status</label>
              <div>${statusBadge}</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">Full Name</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);">${escapeHtml(app.student_name || 'N/A')}</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">Personal Email</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);">${escapeHtml(app.personal_email || 'N/A')}</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">TUP Student Number</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);">${escapeHtml(app.tup_student_number || 'N/A')}</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">Program, Year & Section</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);">${escapeHtml(app.year_section || 'N/A')}</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">College Affiliated</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);">${escapeHtml(app.college_affiliated || 'N/A')}</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">Reason for Joining</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2); min-height: 100px; white-space: pre-wrap;">${escapeHtml(app.notes || 'N/A')}</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">CV/Resume</label>
              ${app.cv_link ? `
                <a href="${escapeHtml(app.cv_link)}" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.1); border: 1px solid rgba(163, 39, 39, 0.3); border-radius: 8px; color: var(--primary, #a32727); text-decoration: none; font-weight: 500;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  View CV/Resume
                </a>
              ` : '<div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2); color: var(--muted, #666);">No CV/Resume uploaded</div>'}
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">Date Submitted</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);">${escapeHtml(submittedDate)}</div>
            </div>

            ${app.reviewed_at ? `
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary, #a32727);">Reviewed At</label>
              <div style="padding: 0.875rem 1rem; background: rgba(163, 39, 39, 0.05); border-radius: 8px; border: 1px solid rgba(163, 39, 39, 0.2);">${escapeHtml(reviewedDate)}</div>
            </div>
            ` : ''}
          </div>
        `;

        // Show modal
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
      }

      /**
       * Initialize application view modal
       */
      function initializeApplicationViewModal() {
        const modal = document.getElementById('applicationViewModal');
        const backdrop = document.getElementById('applicationViewModalBackdrop');
        const closeBtn = document.getElementById('applicationViewModalClose');
        const footerCloseBtn = document.getElementById('applicationViewCloseBtn');

        const closeModal = () => {
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('modal-open');
          document.body.style.overflow = '';
        };

        if (backdrop) backdrop.addEventListener('click', closeModal);
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (footerCloseBtn) footerCloseBtn.addEventListener('click', closeModal);

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.classList.contains('modal-open')) {
            closeModal();
          }
        });
      }

      // Make function globally available for onclick handlers
      window.viewApplication = viewApplication;

      /**
       * Handle CV download
       */
      function handleCvDownload(event, appId) {
        event.preventDefault();
        const app = applications.find(a => a.id === appId);
        if (app && app.cv_link) {
          console.log(`Opening CV for application ${appId}: ${app.cv_link}`);
          window.open(app.cv_link, '_blank', 'noopener,noreferrer');
        }
      }

      // Make function globally available for onclick handlers
      window.handleCvDownload = handleCvDownload;
    </script>
  </body>
</html>