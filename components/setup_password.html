<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TUPConnect • Set Your Password</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="../styles/admin.css" />
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="background-glow" aria-hidden="true"></div>
    
    <main class="login-main">
      <div class="login-container surface">
        <div class="login-header">
          <h1>Set Your Password</h1>
          <p>Create a secure password for your organization account</p>
        </div>

        <!-- Password Setup Form -->
        <form class="login-form" id="passwordSetupForm">
          <div class="form-group">
            <label for="newPassword">New Password *</label>
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              placeholder="Enter your new password"
              required
              autocomplete="new-password"
              minlength="6"
            />
            <small style="color: #666; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
              Password must be at least 6 characters long
            </small>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password *</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              placeholder="Confirm your new password"
              required
              autocomplete="new-password"
              minlength="6"
            />
          </div>

          <!-- Error/Success Message -->
          <div id="passwordMessage" style="display: none; margin-bottom: 1rem;"></div>

          <button type="submit" class="btn-primary" id="submitBtn">Set Password</button>
        </form>

        <div class="login-footer">
          <a href="login.html" class="back-link">← Back to Login</a>
        </div>
      </div>
    </main>

    <script>
      // Initialize Supabase client
      const supabaseUrl = 'https://rbmfimbdtiyuiflunuhx.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJibWZpbWJkdGl5dWlmbHVudWh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA4MDQsImV4cCI6MjA4MDYwNjgwNH0.5LUfiV2PH78x5ExLROR9b0Z9j1O1ND75JJdGnEg2r4E';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

      // Display message helper function
      function displayMessage(message, isError = false) {
        const messageDiv = document.getElementById('passwordMessage');
        if (!messageDiv) return;

        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        messageDiv.style.padding = '0.875rem 1rem';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.fontSize = '0.875rem';

        if (isError) {
          messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
          messageDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
          messageDiv.style.color = '#dc2626';
        } else {
          messageDiv.style.background = 'rgba(34, 197, 94, 0.1)';
          messageDiv.style.border = '1px solid rgba(34, 197, 94, 0.3)';
          messageDiv.style.color = '#16a34a';
        }
      }

      // Hide message helper function
      function hideMessage() {
        const messageDiv = document.getElementById('passwordMessage');
        if (messageDiv) {
          messageDiv.style.display = 'none';
          messageDiv.innerHTML = '';
        }
      }

      // Global variable to track if we have a valid session
      let hasValidSession = false;

      // Function to parse hash parameters from URL
      function parseHashParams(hash) {
        const params = {};
        if (!hash || hash.length <= 1) return params;
        
        const hashString = hash.substring(1); // Remove the #
        const pairs = hashString.split('&');
        
        pairs.forEach(pair => {
          const [key, value] = pair.split('=');
          if (key && value) {
            params[decodeURIComponent(key)] = decodeURIComponent(value);
          }
        });
        
        return params;
      }

      // Wait for page to fully load and Supabase to initialize
      window.addEventListener('load', async () => {
        // Small delay to ensure Supabase client is fully initialized
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Verify session on page load and handle recovery token
        try {
          // Parse URL hash for recovery token
          const urlHash = window.location.hash;
          const hashParams = parseHashParams(urlHash);
          const hasRecoveryToken = hashParams.access_token && hashParams.type === 'recovery';
          
          console.log('=== SESSION INITIALIZATION DEBUG ===');
          console.log('Full URL:', window.location.href);
          console.log('URL Hash:', urlHash);
          console.log('Hash Params:', hashParams);
          console.log('Has Recovery Token:', hasRecoveryToken);

          // Set up auth state change listener FIRST - this is critical
          let authSubscription;
          const sessionPromise = new Promise((resolve) => {
            authSubscription = supabase.auth.onAuthStateChange(async (event, session) => {
              console.log('Auth state changed:', event, session ? 'Has session' : 'No session');
              
              if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'PASSWORD_RECOVERY') {
                if (session) {
                  console.log('✓ Session established via auth state change');
                  hasValidSession = true;
                  hideMessage();
                  resolve(session);
                }
              }
              
              // Resolve after a timeout even if no session (to prevent hanging)
              setTimeout(() => {
                if (!hasValidSession) {
                  resolve(null);
                }
              }, 3000);
            });
          });

          // Check for existing session
          let { data: { session }, error: sessionError } = await supabase.auth.getSession();
          
          console.log('Initial session check:', session ? 'Found' : 'Not found');
          if (sessionError) console.log('Session error:', sessionError);

          // If we already have a session, great!
          if (session) {
            hasValidSession = true;
            console.log('✓ Valid session already exists');
            console.log('User email:', session.user.email);
            console.log('User ID:', session.user.id);
            hideMessage();
            
            // Clean up subscription
            if (authSubscription) {
              setTimeout(() => authSubscription.data?.subscription?.unsubscribe(), 1000);
            }
            return;
          }

          // If no session but we have a recovery token, Supabase should process it
          // The getSession() call above should have triggered processing, but let's wait for auth state change
          if (!session && hasRecoveryToken) {
            console.log('Recovery token detected. Waiting for Supabase to process...');
            
            // Wait for auth state change event (up to 3 seconds)
            const newSession = await sessionPromise;
            
            if (newSession) {
              session = newSession;
              hasValidSession = true;
              console.log('✓ Session established from recovery token');
            } else {
              // If still no session, try getSession again a few times
              console.log('No session from auth state change, retrying getSession...');
              for (let i = 0; i < 5; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                const retryResult = await supabase.auth.getSession();
                if (retryResult.data?.session) {
                  session = retryResult.data.session;
                  hasValidSession = true;
                  console.log(`✓ Session found on retry ${i + 1}`);
                  break;
                }
              }
            }
          }

          // Clean up subscription
          if (authSubscription) {
            setTimeout(() => authSubscription.data?.subscription?.unsubscribe(), 2000);
          }

          // Final check
          if (!session && !hasValidSession) {
            // One final getSession call
            const finalCheck = await supabase.auth.getSession();
            if (finalCheck.data?.session) {
              session = finalCheck.data.session;
              hasValidSession = true;
            }
          }

          console.log('=== FINAL SESSION CHECK ===');
          console.log('Has Valid Session:', hasValidSession);
          console.log('Session:', session ? 'Found' : 'Not found');

          // Show error only if we truly don't have a session
          if (!hasValidSession && !session) {
            if (!hasRecoveryToken) {
              console.error('No recovery token found in URL');
              displayMessage(
                'Invalid or expired activation link. Please make sure you clicked the link directly from your activation email. If the problem persists, request a new activation email from the login page.',
                true
              );
            } else {
              console.error('Recovery token found but session not established');
              displayMessage(
                'Unable to process activation link. The link may be invalid or expired. Please request a new activation email from the login page.',
                true
              );
            }
          } else if (hasValidSession || session) {
            console.log('✓ Session is valid. Password form is ready.');
            hideMessage();
          }

        } catch (error) {
          console.error('Error in session initialization:', error);
          displayMessage(
            'An error occurred while verifying your activation link. Please try again or request a new activation email.',
            true
          );
        }
      });

      /**
       * Complete password setup function for Organization Account Activation
       * 
       * This function:
       * 1. Updates the user's password in Supabase Auth
       * 2. Finds the organization linked to this user (via email match)
       * 3. Updates the organization's account_status to 'Account Activated'
       * 4. Returns success/error status
       * 
       * @param {string} newPassword - The new password to set
       * @returns {Promise<Object>} - Returns { success: boolean, error: string|null }
       */
      async function handlePasswordSetup(newPassword) {
        try {
          // Step 1: Get current session to access user information
          // Use the global flag first, then check session
          if (!hasValidSession) {
            // Try to get session multiple times
            let session = null;
            for (let attempt = 0; attempt < 5; attempt++) {
              const result = await supabase.auth.getSession();
              if (result.data?.session) {
                session = result.data.session;
                hasValidSession = true;
                break;
              }
              await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            if (!session) {
              console.error('No session found after multiple attempts');
              console.error('URL hash:', window.location.hash);
              return {
                success: false,
                error: 'Auth session missing! Please make sure you clicked the link directly from your activation email. If the problem persists, request a new activation email.'
              };
            }
          }
          
          // Get the current session
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          
          if (sessionError || !session || !session.user) {
            console.error('Session error:', sessionError);
            console.error('Session:', session);
            console.error('URL hash:', window.location.hash);
            return {
              success: false,
              error: 'Auth session missing! Please make sure you clicked the link directly from your activation email. If the problem persists, request a new activation email.'
            };
          }

          const userEmail = session.user.email;
          const userId = session.user.id;

          console.log('=== PASSWORD SETUP DEBUG ===');
          console.log('User ID:', userId);
          console.log('User Email:', userEmail);
          console.log('===========================');

          // Step 2: Update user password using Supabase Auth
          const { data: updateData, error: updateError } = await supabase.auth.updateUser({
            password: newPassword
          });

          if (updateError) {
            console.error('Password update error:', updateError);
            return {
              success: false,
              error: updateError.message || 'Failed to set password. Please try again.'
            };
          }

          if (!updateData || !updateData.user) {
            return {
              success: false,
              error: 'Password update failed. Please try again.'
            };
          }

          console.log('✓ Password updated successfully for user:', userId);

          // Step 3: Find the organization linked to this user via email
          // Organizations are linked to users by matching organizations.email with user.email
          const { data: organization, error: orgError } = await supabase
            .from('organizations')
            .select('id, name, email, account_status')
            .eq('email', userEmail)
            .maybeSingle(); // Use maybeSingle() to return null if no match instead of throwing

          if (orgError) {
            console.error('Error finding organization:', orgError);
            // Don't fail the whole operation - password was already updated
            // Just log a warning
            console.warn('Password updated but failed to update organization status:', orgError.message);
            return {
              success: true, // Password was successfully updated
              error: null,
              warning: 'Password set successfully, but could not update organization status. Please contact support.'
            };
          }

          if (!organization) {
            console.warn('No organization found for email:', userEmail);
            // Password was successfully updated, but no organization match
            // This shouldn't happen in normal flow, but we'll handle it gracefully
            return {
              success: true,
              error: null,
              warning: 'Password set successfully, but no matching organization found. Please contact support.'
            };
          }

          console.log('✓ Organization found:', organization.name, '(ID:', organization.id + ')');

          // Step 4: Update the organization's account_status to 'Account Activated'
          const { data: updatedOrg, error: updateStatusError } = await supabase
            .from('organizations')
            .update({ 
              account_status: 'Account Activated'
            })
            .eq('id', organization.id)
            .select()
            .single();

          if (updateStatusError) {
            console.error('Error updating organization status:', updateStatusError);
            // Password was successfully updated, but status update failed
            // Log error but don't fail the whole operation
            console.warn('Password updated but failed to update organization status:', updateStatusError.message);
            return {
              success: true, // Password was successfully updated
              error: null,
              warning: 'Password set successfully, but could not update organization status. Please contact support.'
            };
          }

          console.log('✓ Organization status updated to "Account Activated"');
          console.log('=== PASSWORD SETUP SUCCESS ===');
          console.log('Organization:', updatedOrg.name);
          console.log('New Status:', updatedOrg.account_status);
          console.log('===============================');

          // Success: Both password and organization status updated
          return {
            success: true,
            error: null
          };

        } catch (error) {
          // Handle any unexpected errors
          console.error('handlePasswordSetup unexpected error:', error);
          return {
            success: false,
            error: error.message || 'An unexpected error occurred while setting your password'
          };
        }
      }

      // Form submission handler
      const passwordSetupForm = document.getElementById('passwordSetupForm');
      const submitBtn = document.getElementById('submitBtn');

      passwordSetupForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Hide previous messages
        hideMessage();

        // Get form values
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validate passwords match
        if (newPassword !== confirmPassword) {
          displayMessage('Passwords do not match. Please try again.', true);
          return;
        }

        // Validate password length
        if (newPassword.length < 6) {
          displayMessage('Password must be at least 6 characters long.', true);
          return;
        }

        // Disable submit button during processing
        submitBtn.disabled = true;
        const originalButtonText = submitBtn.textContent;
        submitBtn.textContent = 'Setting Password...';

        // Call password setup function
        const result = await handlePasswordSetup(newPassword);

        if (result.success) {
          // Show success message (include warning if present)
          const successMessage = result.warning 
            ? `✓ Password set successfully! ${result.warning} Redirecting to login page...`
            : '✓ Password set successfully! Redirecting to login page...';
          
          displayMessage(successMessage, false);

          // Wait a moment, then redirect to login page
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else {
          // Show error message
          displayMessage(result.error || 'Failed to set password. Please try again.', true);
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = originalButtonText;
        }
      });

      // Real-time password confirmation validation
      const confirmPasswordInput = document.getElementById('confirmPassword');
      confirmPasswordInput.addEventListener('input', function() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = this.value;

        if (confirmPassword && newPassword !== confirmPassword) {
          this.setCustomValidity('Passwords do not match');
        } else {
          this.setCustomValidity('');
        }
      });
    </script>
  </body>
</html>

