<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TUPConnect • Set Your Password</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="../styles/admin.css" />
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="background-glow" aria-hidden="true"></div>
    
    <main class="login-main">
      <div class="login-container surface">
        <div class="login-header">
          <h1>Set Your Password</h1>
          <p>Create a secure password for your organization account</p>
        </div>

        <!-- Password Setup Form -->
        <form class="login-form" id="passwordSetupForm">
          <div class="form-group">
            <label for="newPassword">New Password *</label>
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              placeholder="Enter your new password"
              required
              autocomplete="new-password"
              minlength="6"
            />
            <small style="color: #666; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
              Password must be at least 6 characters long
            </small>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password *</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              placeholder="Confirm your new password"
              required
              autocomplete="new-password"
              minlength="6"
            />
          </div>

          <!-- Error/Success Message -->
          <div id="passwordMessage" style="display: none; margin-bottom: 1rem;"></div>

          <button type="submit" class="btn-primary" id="submitBtn">Set Password</button>
        </form>

        <div class="login-footer">
          <a href="login.html" class="back-link">← Back to Login</a>
        </div>
      </div>
    </main>

    <script>
      // Initialize Supabase client
      const supabaseUrl = 'https://rbmfimbdtiyuiflunuhx.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJibWZpbWJkdGl5dWlmbHVudWh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA4MDQsImV4cCI6MjA4MDYwNjgwNH0.5LUfiV2PH78x5ExLROR9b0Z9j1O1ND75JJdGnEg2r4E';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

      // Display message helper function
      function displayMessage(message, isError = false) {
        const messageDiv = document.getElementById('passwordMessage');
        if (!messageDiv) return;

        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        messageDiv.style.padding = '0.875rem 1rem';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.fontSize = '0.875rem';

        if (isError) {
          messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
          messageDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
          messageDiv.style.color = '#dc2626';
        } else {
          messageDiv.style.background = 'rgba(34, 197, 94, 0.1)';
          messageDiv.style.border = '1px solid rgba(34, 197, 94, 0.3)';
          messageDiv.style.color = '#16a34a';
        }
      }

      // Hide message helper function
      function hideMessage() {
        const messageDiv = document.getElementById('passwordMessage');
        if (messageDiv) {
          messageDiv.style.display = 'none';
          messageDiv.innerHTML = '';
        }
      }

      // Verify session on page load
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          // Check if there's a valid session or recovery token in the URL
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          
          // Also check URL hash for recovery token (Supabase adds this to the redirect URL)
          const urlHash = window.location.hash;
          const hasRecoveryToken = urlHash.includes('access_token') || urlHash.includes('type=recovery');

          if (sessionError && !hasRecoveryToken) {
            console.error('Session check error:', sessionError);
            displayMessage(
              'Invalid or expired activation link. Please request a new activation email from the login page.',
              true
            );
            return;
          }

          // If no session and no recovery token, show error
          if (!session && !hasRecoveryToken) {
            displayMessage(
              'Invalid or expired activation link. Please request a new activation email from the login page.',
              true
            );
            return;
          }

          // Valid session or recovery token found - user can proceed
          console.log('Valid session or recovery token found. User can set password.');

        } catch (error) {
          console.error('Error checking session:', error);
          displayMessage(
            'An error occurred while verifying your activation link. Please try again or request a new activation email.',
            true
          );
        }
      });

      // Handle password setup
      async function handlePasswordSetup(newPassword) {
        try {
          // Update user password using Supabase
          const { data, error } = await supabase.auth.updateUser({
            password: newPassword
          });

          if (error) {
            console.error('Password update error:', error);
            return {
              success: false,
              error: error.message || 'Failed to set password. Please try again.'
            };
          }

          if (!data || !data.user) {
            return {
              success: false,
              error: 'Password update failed. Please try again.'
            };
          }

          // Success: password updated
          console.log('Password setup success: Password updated for user', data.user.id);
          return {
            success: true,
            error: null
          };

        } catch (error) {
          console.error('handlePasswordSetup unexpected error:', error);
          return {
            success: false,
            error: error.message || 'An unexpected error occurred while setting your password'
          };
        }
      }

      // Form submission handler
      const passwordSetupForm = document.getElementById('passwordSetupForm');
      const submitBtn = document.getElementById('submitBtn');

      passwordSetupForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Hide previous messages
        hideMessage();

        // Get form values
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validate passwords match
        if (newPassword !== confirmPassword) {
          displayMessage('Passwords do not match. Please try again.', true);
          return;
        }

        // Validate password length
        if (newPassword.length < 6) {
          displayMessage('Password must be at least 6 characters long.', true);
          return;
        }

        // Disable submit button during processing
        submitBtn.disabled = true;
        const originalButtonText = submitBtn.textContent;
        submitBtn.textContent = 'Setting Password...';

        // Call password setup function
        const result = await handlePasswordSetup(newPassword);

        if (result.success) {
          // Show success message
          displayMessage(
            '✓ Password set successfully! Redirecting to login page...',
            false
          );

          // Wait a moment, then redirect to login page
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else {
          // Show error message
          displayMessage(result.error || 'Failed to set password. Please try again.', true);
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = originalButtonText;
        }
      });

      // Real-time password confirmation validation
      const confirmPasswordInput = document.getElementById('confirmPassword');
      confirmPasswordInput.addEventListener('input', function() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = this.value;

        if (confirmPassword && newPassword !== confirmPassword) {
          this.setCustomValidity('Passwords do not match');
        } else {
          this.setCustomValidity('');
        }
      });
    </script>
  </body>
</html>

